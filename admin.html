<!DOCTYPE html>
<html lang="en" class="theme-light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MTERMS 2026 — Admin</title>

  <!-- Reuse your main CSS -->
  <link rel="stylesheet" href="assets/styles.css" />

  <!-- Theme overrides + hero-independent palette -->
  <style id="theme-overrides">
    :root.theme-light{--bg:#fff;--surface:#fff;--text:#0b1115;--border:#e5e7eb;--muted:#667085;}
    html,body{background:var(--bg);color:var(--text);}
    .admin-wrap{width:min(1200px,92vw);margin:24px auto;}
    .admin-head{display:flex;align-items:center;justify-content:space-between;margin:8px 0 16px;}
    .theme-toggle{margin-left:8px;border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer;background:#fff;color:#0b1115}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    input,select,textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text)}

    /* IMPORTANT: don't apply 100% width to checkbox/radio */
input[type="checkbox"],
input[type="radio"]{
  width:auto !important;
  padding:0 !important;
  border:none !important;
  box-shadow:none !important;
}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    th,td{padding:8px;border-bottom:1px solid var(--border)}
    th{text-align:left}
    .actions{display:flex;gap:8px}
    .btn{border:1px solid var(--border);border-radius:8px;padding:8px 12px;background:#fff;cursor:pointer}
    .btn.ghost{background:transparent}
    .badge{width:260px;height:400px;background:#fff;color:#0b1115;border-radius:16px;border:1px solid #e8e8e8;box-shadow:0 8px 24px rgba(0,0,0,.08);display:flex;flex-direction:column;overflow:hidden}
    .badge-top{padding:8px 10px 4px}
    .badge-logos{display:flex;justify-content:center;align-items:center;gap:8px}
    .badge-logos img{height:20px}
    .badge-photo-wrap{margin:8px auto 0;width:180px;height:240px;position:relative;border:1px solid #ddd;border-radius:10px;overflow:hidden;background:#f2f4f7}
    .badge-photo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
    .badge-info{text-align:center;padding:10px 12px 0}
    .badge-name{font-weight:800;font-size:18px}
    .badge-affil{font-size:12px;color:#475467}
    .badge-cat{font-size:12px;color:#0b7a64;font-weight:700;margin-top:6px}
    .badge-footer{margin-top:auto;font-size:11px;text-align:center;padding:8px 10px 10px;color:#667085;border-top:1px solid #eef2f6;background:#fafafa}

    /* print */
    @media print{
      body{background:#fff;color:#000}
      .no-print{display:none !important}
      .print-grid{display:grid;grid-template-columns:repeat(2, 280px);gap:20px}
      .badge{break-inside:avoid}
    }

    /* ---------- Readability fixes (target only the faint areas) ---------- */

/* 1) Inputs: ensure good text + placeholder contrast */
input, select, textarea { color: var(--text); }
input::placeholder, textarea::placeholder { color: var(--muted); opacity: 1; }

/* 2) Table headers: stronger contrast in light & dark */
table thead th {
  color: var(--text);
  font-weight: 600;
}

/* 3) Buttons: make disabled states readable (remove default washed-out opacity) */
.btn:disabled,
button[disabled] {
  opacity: 1;                     /* cancel browser fade */
  cursor: not-allowed;
  border-color: var(--border);
}

/* Light theme disabled buttons */
.theme-light .btn:disabled,
.theme-light button[disabled] {
  background: #eef2f7;            /* soft grey on white */
  color: #6b7280;                  /* slate-500 for legibility */
}



/* 4) Ghost buttons (e.g., Logout) need clearer text outlines in light mode */
.theme-light .btn.ghost {
  color: #0b1115;                  /* solid dark text */
  background: transparent;
  border-color: var(--border);
}

/* 5) Make the small “Edit” buttons readable even when disabled */
.actions .btn:disabled {
  font-weight: 600;
}

  </style>
</head>
<body>
  <div class="admin-wrap">
    <div class="admin-head">
      <div>
        <h1 style="margin:0">MTERMS 2026 — Admin</h1>
        <div style="opacity:.8">Manage participants, edit details, preview photos, and print badges.</div>
      </div>
      <div class="no-print">

        <button 
  onclick="window.location.href='index.html'" 
  style="
    display:inline-block;
    margin-top:12px;
    padding:6px 12px;
    border:none;
    border-radius:8px;
    background:linear-gradient(90deg,#19c37d,#0ea5a6);
    color:#fff;
    font-weight:600;
    font-size:13px;
    cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease;
  "
  onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,.25)';"
  onmouseout="this.style.transform='';this.style.boxShadow='';"
>
  ← Back to Main Page
</button>


        <button 
  onclick="window.location.href='committee-appointment.html'" 
  style="
    display:inline-block;
    margin-top:12px;
    margin-left:8px;
    padding:6px 12px;
    border:none;
    border-radius:8px;
    background:linear-gradient(90deg,#6366f1,#0ea5e9);
    color:#fff;
    font-weight:600;
    font-size:13px;
    cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease;
  "
  onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,.25)';"
  onmouseout="this.style.transform='';this.style.boxShadow='';"
>
  Committee Appointment Letter
</button>



        
        
        <button id="logoutBtn" class="btn ghost">Logout</button>
      </div>
    </div>

    <!-- Login card -->
    <div id="loginCard" class="card">
      <h3>Admin Login</h3>
      <div class="row">
        <label>Username <input id="aUser" value="admin"></label>
        <label>Password <input id="aPass" type="password" value="admin"></label>
      </div>
      <button id="aLogin" class="btn">Login</button>
      <span id="aMsg" style="margin-left:8px;font-size:.95rem"></span>
    </div>

    <!-- Dashboard -->
    <div id="dash" class="no-print" style="display:none">
      <div class="card">
        <div class="row">
          <label>Search (name, email, code)
            <input id="q" placeholder="e.g., Rahman, uitm.edu, MTERM2026-000123">
          </label>
          <div style="display:flex;gap:8px;align-items:end">
            <button id="refresh" class="btn">Refresh</button>
            <button id="printSel" class="btn">Print selected badges</button>
          </div>
        </div>
      </div>

      <div class="card" style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th><input type="checkbox" id="selAll"></th>
              <th>Code</th>
              <th>Name</th>
              <th>Category</th>
              <th>Email</th>
              <th>Payment</th>
              <th>Affiliation</th>
              <th style="width:160px">Actions</th>
            </tr>
          </thead>
          <tbody id="rows">
            <!-- populated by JS -->
          </tbody>
        </table>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button id="prev" class="btn ghost">Prev</button>
          <span id="pageInfo" style="align-self:center"></span>
          <button id="next" class="btn ghost">Next</button>
        </div>
      </div>

      <!-- Edit panel -->
      <div class="card" id="editCard" style="display:none">
        <h3>Edit Participant</h3>
        <div id="editCode" style="opacity:.8;margin-bottom:6px"></div>
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
  <label style="flex:1 1 600px;margin:0;min-width:280px">Category
    <select id="f-category" style="width:100%">
      <option value="student">Student</option>
      <option value="academia">Academia</option>
      <option value="industry">Industry</option>
    </select>
  </label>


</div>


        <h4>Personal</h4>
        <div class="row">
          <input id="p-firstName" placeholder="First name">
          <input id="p-lastName" placeholder="Last name">
          <input id="p-email" placeholder="Email">
          <input id="p-phone" placeholder="Phone">
          <input id="p-country" placeholder="Country">
        </div>

        <h4>Professional</h4>
        <div class="row">
          <input id="pro-affiliation" placeholder="University / Company">
          <input id="pro-dept" placeholder="Department">
          <input id="pro-role" placeholder="Role/Title">
        </div>

        <div id="studentOnly" style="display:none">
          <h4>Student</h4>
          <div class="row-3">
            <input id="s-university" placeholder="University">
            <select id="s-level">
              <option value="">Level</option><option>UG</option><option>MSc</option><option>PhD</option><option>Other</option>
            </select>
            <input id="s-grad" type="number" placeholder="Expected grad year">
          </div>
        </div>

        <h4>Program</h4>
        <div class="row">
          <label class="field-inline" style="display:flex;align-items:center;gap:8px">
<input type="checkbox" id="pr-presenting"> I am a presenter
          </label>
          <select id="pr-type">
            <option value="none">None</option><option value="talk">Oral</option><option value="poster">Poster</option><option value="workshop">Workshop</option>
          </select>
          <input id="pr-title" placeholder="Presentation title">
          <input id="pr-topic" placeholder="Topic area">
        </div>



        <!-- Submission (Theme + Field + Authors) -->
        <div class="card" id="ad-submissionCard" style="display:none;margin-top:12px">
          <h4>Abstract / Authors Details</h4>
          <div style="opacity:.85;margin-top:-6px;margin-bottom:10px">
            Theme, respective field, and author list (up to 10). Tick <strong>one</strong> corresponding author only.
          </div>

          <div class="row">
            <label>Theme
              <select id="ad-sub-theme">
                <option value="">Select theme</option>
              </select>
            </label>

            <label>Respective Field
              <select id="ad-sub-field" disabled>
                <option value="">Select field</option>
              </select>
            </label>
          </div>

          <label>Submission / Abstract Title
            <input id="ad-sub-title" placeholder="e.g., Scaffold-assisted stem cell regeneration...">
          </label>

          <div id="ad-subMsg" style="margin:6px 0 12px;opacity:.9"></div>

<!-- Authors (dynamic, up to 10) -->
<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px">
  <button type="button" id="ad-addAuthorBtn" class="btn">+ Add author</button>
  <button type="button" id="ad-removeAuthorBtn" class="btn ghost">Remove last</button>
  <span style="opacity:.85" id="ad-authorCountTxt"></span>
</div>

<div id="ad-authorsWrap"></div>

<template id="ad-authorTpl">
  <fieldset style="border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px">
    <legend>Author __N__</legend>

    <div style="display:flex;justify-content:flex-end;margin:-6px 0 8px">
      <button type="button" class="btn ghost adAuthorRemoveOneBtn">Remove this author</button>
    </div>

    <div class="row-3">
      <label>First name <input id="ad-a__N__-first" placeholder="First name"></label>
      <label>Last name <input id="ad-a__N__-last" placeholder="Last name"></label>
      <label>Email <input id="ad-a__N__-email" type="email" placeholder="email@example.com"></label>
    </div>

    <div class="row">
      <label>Affiliation <input id="ad-a__N__-affil" placeholder="University / Company"></label>
      <label>Country <input id="ad-a__N__-country" placeholder="Country"></label>
    </div>

    <label class="field-inline">
      <input type="radio" name="adCorrAuthor" id="ad-a__N__-corr"> Corresponding author
    </label>
  </fieldset>
</template>       
        
        </div>


        
        <h4>Billing</h4>
        <div class="row">
          <input id="b-billTo" placeholder="Bill-to name">
          <input id="b-taxNo" placeholder="Company Tax/GST/VAT No.">
          <input id="b-po" placeholder="PO number">
        </div>

        <h4>Address</h4>
        <div class="row-3">
          <input id="a-line1" placeholder="Address line 1">
          <input id="a-line2" placeholder="Address line 2">
          <input id="a-city" placeholder="City">
          <input id="a-state" placeholder="State/Province">
          <input id="a-postcode" placeholder="Postcode">
          <input id="a-country" placeholder="Country">
        </div>

        <h4>Consents</h4>
        <div class="row">
          <label><input type="checkbox" id="c-pdpa"> PDPA</label>
          <label><input type="checkbox" id="c-coc"> Code of Conduct</label>
          <label><input type="checkbox" id="c-mkt"> Marketing opt-in</label>
        </div>

        <h4>Payment</h4>
        <div class="row">
          <select id="pay-status">
            <option value="pending">pending</option>
            <option value="paid">paid</option>
            <option value="verified">verified</option>
          </select>
          <input id="pay-amount" type="number" placeholder="Amount (MYR)">
        </div>

        <div class="row">
          <button id="save" class="btn">Save changes</button>
          <span id="saveMsg" style="align-self:center"></span>
        </div>

        <h4>Photo</h4>
        <div class="row">
          <div>
            <div class="badge">
              <div class="badge-top">
                <div class="badge-logos">
                  <img src="public/uitm.png" alt="UiTM">
                  <img src="public/mohe.png" alt="MOHE">
                  <img src="public/tesma.png" alt="TESMA">
                </div>
              </div>
              <div class="badge-photo-wrap">
                <img id="badgePhoto" class="badge-photo" alt="ID photo">
              </div>
              <div class="badge-info">
                <div id="badgeName" class="badge-name">Participant Name</div>
                <div id="badgeAffil" class="badge-affil">Institution / Company</div>
                <div id="badgeCat" class="badge-cat">CATEGORY</div>
              </div>
              <div class="badge-footer">MTERMS 2026 • Shah Alam</div>
            </div>
            <div style="margin-top:8px" class="no-print">
              <button id="printBadge" class="btn">Print this badge</button>
            </div>
          </div>
          <div>
            <div id="photoMsg" style="opacity:.9"></div>
            <button id="loadPhoto" class="btn">Load latest photo</button>
          </div>
        </div>
      </div>

      <!-- Hidden print layout for selected badges -->
      <div id="printArea" class="print-grid" style="display:none"></div>
    </div>
  </div>

  <script>
   

    // Simple client-side auth (dev only) — matches Basic auth we'll add on backend (admin/admin)
    const ADMIN_KEY='mterms-admin-basic';
    function authHeader(){
      const token = localStorage.getItem(ADMIN_KEY);
      return token ? {'Authorization':'Basic '+token} : {};
    }

    const API='https://mterm2026-559f9bf571b5.herokuapp.com';
    const $=id=>document.getElementById(id);





        // ===== Submission (theme/field/authors) for Admin =====
    const adSubCard  = $('ad-submissionCard');
    const adSubTheme = $('ad-sub-theme');
    const adSubField = $('ad-sub-field');
    const adSubTitle = $('ad-sub-title');
    const adSubMsg   = $('ad-subMsg');

    const THEME_FIELDS = {
      "Stem Cell Innovations and Clinical Applications": [
        "Stem Cell Biology and Mechanisms of Differentiation",
        "Tissue Engineering and Biomaterials",
        "Organoids and 3D Bioprinting",
        "Regenerative Medicine and Translational Therapies",
        "Cellular Reprogramming and Induced Pluripotent Stem Cells (iPSCs)",
        "Clinical Trials and Regulatory Science in Stem Cell Therapy",
        "Gene Editing and Cell Engineering",
        "Immunomodulation and Stem Cell Interactions",
        "Neural Stem Cells and Neuroregeneration",
        "Musculoskeletal Regeneration",
        "Cardiac and Vascular Regeneration",
        "Hepatic and Pancreatic Regeneration",
        "Stem Cell-Derived Extracellular Vesicles and Secretome Therapy",
        "Biomanufacturing and GMP Production of Stem Cells",
        "Ethics, Policy, and Commercialization in Regenerative Medicine",
        "Other relevant fields"
      ],
      "Biomaterials and Tissue Scaffolds": [
        "Design and Development of Novel Biomaterials",
        "Biocompatibility and Biofunctionality Assessment",
        "3D Bioprinting and Additive Manufacturing",
        "Smart and Responsive Biomaterials",
        "Hydrogels and Injectable Scaffolds",
        "Nanomaterials in Tissue Engineering",
        "Bioactive Surface Modification",
        "Degradable and Bioresorbable Scaffolds",
        "Mechanical and Structural Characterization of Scaffolds",
        "Vascularization Strategies in Engineered Tissues",
        "Cell–Material Interactions and Mechanotransduction",
        "Composite and Hybrid Scaffolds",
        "Scaffold-Based Organoid and Tissue Models",
        "Clinical Translation and Regulatory Challenges in Biomaterials",
        "Sustainable and Green Biomaterials",
        "Other relevant fields"
      ],
      "Student and Young Investigator Symposium (SYIS)": [
        "All fields listed above (SYIS)"
      ]
    };

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function initAdminSubmissionUI(){
      adSubTheme.innerHTML =
        `<option value="">Select theme</option>` +
        Object.keys(THEME_FIELDS).map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');

      adSubField.innerHTML = `<option value="">Select field</option>`;
      adSubField.disabled = true;

      adSubTheme.addEventListener('change', () => {
        const t = adSubTheme.value;
        const fields = THEME_FIELDS[t] || [];
        adSubField.innerHTML =
          `<option value="">Select field</option>` +
          fields.map(f => `<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join('');
        adSubField.disabled = !fields.length;
      });
    }

    function toggleAdminSubmission(on){
      adSubCard.style.display = on ? 'block' : 'none';
      adSubMsg.textContent = '';
    }
    // ===== Dynamic Authors (Admin) =====
    const adAuthorsWrap = $('ad-authorsWrap');
    const adAuthorTpl = document.getElementById('ad-authorTpl');
    const adAddAuthorBtn = document.getElementById('ad-addAuthorBtn');
    const adRemoveAuthorBtn = document.getElementById('ad-removeAuthorBtn');
    const adAuthorCountTxt = document.getElementById('ad-authorCountTxt');

    const AD_MAX_AUTHORS = 10;
    let adAuthorCount = 1;

    function adClamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function setAdAuthorCount(n){
      adAuthorCount = adClamp(n, 1, AD_MAX_AUTHORS);
      renderAdAuthors();
    }

    function renderAdAuthors(){
      adAuthorsWrap.innerHTML = '';

      for (let i = 1; i <= adAuthorCount; i++){
        const html = adAuthorTpl.innerHTML.replaceAll('__N__', String(i));
        const temp = document.createElement('div');
        temp.innerHTML = html.trim();
        const fieldset = temp.firstElementChild;

        const removeThisBtn = fieldset.querySelector('.adAuthorRemoveOneBtn');
        if (i === 1){
          removeThisBtn.style.display = 'none';
        } else {
          removeThisBtn.addEventListener('click', () => {
            removeAdAuthorAt(i);
          });
        }

        adAuthorsWrap.appendChild(fieldset);
      }

      adAddAuthorBtn.disabled = adAuthorCount >= AD_MAX_AUTHORS;
      adRemoveAuthorBtn.disabled = adAuthorCount <= 1;
      adAuthorCountTxt.textContent = `${adAuthorCount} / ${AD_MAX_AUTHORS} author(s) shown`;
    }

    function readAdAuthorAt(i){
      const first = $(`ad-a${i}-first`)?.value?.trim() || '';
      const last  = $(`ad-a${i}-last`)?.value?.trim()  || '';
      const email = $(`ad-a${i}-email`)?.value?.trim() || '';
      const affil = $(`ad-a${i}-affil`)?.value?.trim() || '';
      const country = $(`ad-a${i}-country`)?.value?.trim() || '';
      const isCorr = !!$(`ad-a${i}-corr`)?.checked;

      const anyFilled = !!(first || last || email || affil || country);
      if (!anyFilled) return null;

      return { firstName:first, lastName:last, email, affiliation:affil, country, isCorresponding:isCorr };
    }

    function writeAdAuthorAt(i, a){
      $(`ad-a${i}-first`).value = a?.firstName || '';
      $(`ad-a${i}-last`).value  = a?.lastName || '';
      $(`ad-a${i}-email`).value = a?.email || '';
      $(`ad-a${i}-affil`).value = a?.affiliation || '';
      $(`ad-a${i}-country`).value = a?.country || '';
      $(`ad-a${i}-corr`).checked = !!a?.isCorresponding;
    }

    function normalizeAdCorrespondingAuthor(){
      let found = false;
      for (let i = 1; i <= adAuthorCount; i++){
        const r = $(`ad-a${i}-corr`);
        if (!r) continue;
        if (r.checked && !found) { found = true; }
        else if (r.checked && found) { r.checked = false; }
      }
    }

    function removeAdAuthorAt(idx){
      const arr = [];
      for (let i = 1; i <= adAuthorCount; i++){
        arr.push(readAdAuthorAt(i));
      }
      arr.splice(idx - 1, 1);

      adAuthorCount = Math.max(1, adAuthorCount - 1);
      renderAdAuthors();

      for (let i = 1; i <= adAuthorCount; i++){
        writeAdAuthorAt(i, arr[i-1]);
      }
      normalizeAdCorrespondingAuthor();
    }

    adAddAuthorBtn.addEventListener('click', () => setAdAuthorCount(adAuthorCount + 1));
    adRemoveAuthorBtn.addEventListener('click', () => setAdAuthorCount(adAuthorCount - 1));

    // keep compatibility with existing validation logic
    function getAdAuthor(i){
      return readAdAuthorAt(i);
    }

    function readAdminSubmissionFromForm(){
      const theme = adSubTheme.value || '';
      const field = adSubField.value || '';
      const title = adSubTitle.value?.trim() || '';

      const authors = [];
      for (let i = 1; i <= adAuthorCount; i++){
        const a = getAdAuthor(i);
        if (a) authors.push(a);
      }
      return { theme, field, title, authors };
    }

    function writeAdminSubmissionToForm(sub){
      const theme = sub?.theme || '';
      const field = sub?.field || '';
      const title = sub?.title || '';
      const authors = Array.isArray(sub?.authors) ? sub.authors : [];

      adSubTheme.value = theme;

      const fields = THEME_FIELDS[theme] || [];
      adSubField.innerHTML =
        `<option value="">Select field</option>` +
        fields.map(f => `<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join('');
      adSubField.disabled = !fields.length;

      adSubField.value = field;
      adSubTitle.value = title;

      setAdAuthorCount(adClamp(Math.max(1, authors.length), 1, AD_MAX_AUTHORS));

      for (let i = 1; i <= adAuthorCount; i++){
        writeAdAuthorAt(i, null);
      }

      authors.slice(0, AD_MAX_AUTHORS).forEach((a, idx) => {
        writeAdAuthorAt(idx + 1, a);
      });

      normalizeAdCorrespondingAuthor();
    }

    // initial render
    renderAdAuthors();

    function validateAdminSubmissionIfPresenter(){
      adSubMsg.textContent = '';
      if (!$('pr-presenting').checked) return { ok:true };

      const sub = readAdminSubmissionFromForm();
      const anySubData = !!(sub.theme || sub.field || sub.title || sub.authors.length);
      if (!anySubData) return { ok:true };

      if (!sub.theme) return { ok:false, msg:'❌ Please select a Theme.' };
      if (!sub.field) return { ok:false, msg:'❌ Please select a Respective Field.' };
      if (!sub.authors.length) return { ok:false, msg:'❌ Please fill at least Author 1.' };

      const corrCount = sub.authors.filter(a => a.isCorresponding).length;
      if (corrCount !== 1) return { ok:false, msg:'❌ Please tick exactly ONE corresponding author.' };

      return { ok:true };
    }

    // init once
    initAdminSubmissionUI();

    // show/hide on presenter toggle
    $('pr-presenting').addEventListener('change', () => {
      toggleAdminSubmission($('pr-presenting').checked);
    });
    // Login flow
    $('aLogin').addEventListener('click',()=>{
      const u=$('aUser').value.trim(), p=$('aPass').value;
      if(!u||!p){$('aMsg').textContent='❌ Enter username & password';return;}
      const token=btoa(u+':'+p);
      localStorage.setItem(ADMIN_KEY, token);
      $('aMsg').textContent='✅ Logged in';
      $('loginCard').style.display='none';
      $('dash').style.display='block';
      loadPage(1);
    });
    $('logoutBtn').addEventListener('click',()=>{
      localStorage.removeItem(ADMIN_KEY); location.reload();
    });

    // Table/pagination
    let page=1, limit=20, total=0, rows=[];
    async function loadPage(p){
      page=p;
      $('rows').innerHTML='<tr><td colspan="8">Loading…</td></tr>';
      const q = encodeURIComponent($('q').value||'');
      try{
        const r = await fetch(`${API}/api/admin/registrations?page=${page}&limit=${limit}&q=${q}`, { headers: authHeader() });
        const data = await r.json();
        if(!r.ok) throw new Error(data.error||'HTTP '+r.status);
        rows=data.rows||[]; total=data.total||0;
        $('rows').innerHTML = rows.map(doc=>{
          const name=[doc.personal?.firstName||'',doc.personal?.lastName||''].join(' ').trim();
          return `<tr>
            <td><input type="checkbox" class="sel" data-id="${doc._id}" data-code="${doc.regCode}" data-email="${doc.personal?.email||''}" data-name="${name}" data-aff="${doc.professional?.affiliation||''}" data-cat="${(doc.category||'').toUpperCase()}"></td>
            <td>${doc.regCode||''}</td>
            <td>${name||''}</td>
            <td>${doc.category||''}</td>
            <td>${doc.personal?.email||''}</td>
            <td>${doc.payment?.status||'pending'}</td>
            <td>${doc.professional?.affiliation||''}</td>
            <td class="actions">
              <button class="btn" data-act="edit" data-id="${doc._id}">Edit</button>
            </td>
          </tr>`;
        }).join('') || '<tr><td colspan="8"><em>No results</em></td></tr>';
        $('pageInfo').textContent = `Page ${page} • ${Math.min(page*limit, total)} / ${total}`;
      }catch(err){
        $('rows').innerHTML = `<tr><td colspan="8" style="color:#c00">❌ ${err.message}</td></tr>`;
      }
    }

    $('refresh').addEventListener('click',()=>loadPage(1));
    $('prev').addEventListener('click',()=>{if(page>1) loadPage(page-1);});
    $('next').addEventListener('click',()=>{if(page*limit<total) loadPage(page+1);});
    $('q').addEventListener('input',()=>{clearTimeout(window._t); window._t=setTimeout(()=>loadPage(1),300);});

    // Row actions
    document.getElementById('tbl').addEventListener('click',async(e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const act = btn.dataset.act, id = btn.dataset.id;
      if(act==='edit'){ openEditor(id); }
    });

    // Load one doc and fill editor
    async function openEditor(id){
      try{
        const r = await fetch(`${API}/api/admin/registrations/${id}`, { headers: authHeader() });
        const {doc} = await r.json();
        if(!r.ok) throw new Error('Load failed');

        // Fill
        $('editCard').style.display='block';
        $('editCode').textContent = doc.regCode;
        $('f-category').value = doc.category || 'academia';

        $('p-firstName').value = doc.personal?.firstName||'';
        $('p-lastName').value  = doc.personal?.lastName||'';
        $('p-email').value     = doc.personal?.email||'';
        $('p-phone').value     = doc.personal?.phone||'';
        $('p-country').value   = doc.personal?.country||'';

        $('pro-affiliation').value = doc.professional?.affiliation||'';
        $('pro-dept').value        = doc.professional?.department||'';
        $('pro-role').value        = doc.professional?.roleTitle||'';

        const isStudent = (doc.category==='student');
        $('studentOnly').style.display = isStudent ? 'block' : 'none';
        $('s-university').value = doc.student?.university||'';
        $('s-level').value      = doc.student?.level||'';
        $('s-grad').value       = doc.student?.expectedGradYear||'';

        $('pr-presenting').checked = !!doc.program?.presenting;
        $('pr-type').value   = doc.program?.type||'none';
        $('pr-title').value  = doc.program?.title||'';
        $('pr-topic').value  = doc.program?.topicArea||'';



                // Submission: show only if presenter
        toggleAdminSubmission(!!doc.program?.presenting);
        writeAdminSubmissionToForm(doc.submission || {});

        $('b-billTo').value = doc.billing?.billTo||'';
        $('b-taxNo').value  = doc.billing?.taxNo||'';
        $('b-po').value     = doc.billing?.poNumber||'';

        $('a-line1').value = doc.address?.line1||'';
        $('a-line2').value = doc.address?.line2||'';
        $('a-city').value  = doc.address?.city||'';
        $('a-state').value = doc.address?.state||'';
        $('a-postcode').value = doc.address?.postcode||'';
        $('a-country').value  = doc.address?.country||'';

        $('c-pdpa').checked = !!doc.consents?.pdpa;
        $('c-coc').checked  = !!doc.consents?.codeOfConduct;
        $('c-mkt').checked  = !!doc.consents?.marketingOptIn;

        $('pay-status').value = doc.payment?.status||'pending';
        $('pay-amount').value = doc.payment?.amount||'';

        // Badge preview text
        $('badgeName').textContent = [doc.personal?.firstName||'',doc.personal?.lastName||''].join(' ').trim()||'Participant Name';
        $('badgeAffil').textContent = doc.professional?.affiliation||'Institution / Company';
        $('badgeCat').textContent = (doc.category||'Participant').toUpperCase();

        // Bind save
        $('save').onclick = ()=>saveChanges(id, doc);
        $('printBadge').onclick = ()=>{window.print();};
        $('loadPhoto').onclick = ()=>loadLatestPhoto(doc.regCode, doc.personal?.email);
      }catch(err){
        alert('Failed to open editor: '+err.message);
      }
    }

    async function saveChanges(id, orig){
      $('save').disabled = true; $('saveMsg').textContent = 'Saving…';
      const updates = {
        category: $('f-category').value,
        personal: {
          firstName:$('p-firstName').value.trim(), lastName:$('p-lastName').value.trim(),
          email:$('p-email').value.trim(), phone:$('p-phone').value.trim(), country:$('p-country').value.trim()
        },
        professional: {
          affiliation:$('pro-affiliation').value.trim(), department:$('pro-dept').value.trim(), roleTitle:$('pro-role').value.trim()
        },
        student: ($('f-category').value==='student') ? {
          university:$('s-university').value.trim(), level:$('s-level').value, expectedGradYear:$('s-grad').value?Number($('s-grad').value):undefined
        } : undefined,
        program: {
          presenting:$('pr-presenting').checked, type:$('pr-type').value, title:$('pr-title').value.trim(), topicArea:$('pr-topic').value.trim()
        },

                submission: readAdminSubmissionFromForm(),

        
        billing: { billTo:$('b-billTo').value.trim(), taxNo:$('b-taxNo').value.trim(), poNumber:$('b-po').value.trim() },
        address: { line1:$('a-line1').value.trim(), line2:$('a-line2').value.trim(), city:$('a-city').value.trim(), state:$('a-state').value.trim(), postcode:$('a-postcode').value.trim(), country:$('a-country').value.trim() },
        consents: { pdpa:$('c-pdpa').checked, codeOfConduct:$('c-coc').checked, marketingOptIn:$('c-mkt').checked },
        payment: { status:$('pay-status').value, amount:$('pay-amount').value?Number($('pay-amount').value):undefined }
      };
      if (updates.student===undefined) delete updates.student;

            const v = validateAdminSubmissionIfPresenter();
      if (!v.ok) {
        $('saveMsg').textContent = v.msg;
        $('save').disabled = false;
        return;
      }
      
      try{
        const r = await fetch(`${API}/api/admin/registrations/${id}`, {
          method:'PUT',
          headers:{ 'Content-Type':'application/json', ...authHeader() },
          body: JSON.stringify({ updates })
        });
        const data = await r.json();
        if(!r.ok) throw new Error(data.error||'Update failed');
        $('saveMsg').textContent='✅ Saved';
        loadPage(page);
      }catch(err){
        $('saveMsg').textContent='❌ '+err.message;
      }finally{
        $('save').disabled = false;
      }
    }

    async function loadLatestPhoto(regCode, email){
      const el=$('photoMsg'); el.textContent='Loading photo…';
      try{
        const r = await fetch(`${API}/api/uploads/history?regCode=${encodeURIComponent(regCode)}&email=${encodeURIComponent(email)}&type=profilePhoto`);
        const data = await r.json();
        if(!r.ok) throw new Error(data.error||'Error');
        if(data.count){
          const last = data.rows[data.rows.length-1];
          $('badgePhoto').src = `${API}${last.downloadUrl}`;
          el.textContent='✅ Loaded';
        }else{
          $('badgePhoto').removeAttribute('src');
          el.textContent='No photo on file.';
        }
      }catch(err){ el.textContent='❌ '+err.message; }
    }

    // Bulk print for selected
    $('printSel').addEventListener('click', async ()=>{
      const checks=[...document.querySelectorAll('.sel:checked')];
      if(!checks.length){ alert('Select at least one row.'); return; }
      const area=$('printArea'); area.innerHTML=''; area.style.display='grid';
      for(const c of checks){
        const div=document.createElement('div'); div.className='badge';
        div.innerHTML = `
          <div class="badge-top">
            <div class="badge-logos">
              <img src="public/uitm.png" alt="UiTM">
              <img src="public/mohe.png" alt="MOHE">
              <img src="public/tesma.png" alt="TESMA">
            </div>
          </div>
          <div class="badge-photo-wrap"><img class="badge-photo" src="" alt="ID"></div>
          <div class="badge-info">
            <div class="badge-name">${c.dataset.name||'Participant Name'}</div>
            <div class="badge-affil">${c.dataset.aff||'Institution / Company'}</div>
            <div class="badge-cat">${(c.dataset.cat||'PARTICIPANT')}</div>
          </div>
          <div class="badge-footer">MTERMS 2026 • Shah Alam</div>`;
        // try fetch latest photo
        try{
          const r = await fetch(`${API}/api/uploads/history?regCode=${encodeURIComponent(c.dataset.code)}&email=${encodeURIComponent(c.dataset.email)}&type=profilePhoto`);
          const data = await r.json();
          if(r.ok && data.count){
            const last=data.rows[data.rows.length-1];
            div.querySelector('.badge-photo').src = `${API}${last.downloadUrl}`;
          }
        }catch{}
        area.appendChild(div);
      }
      window.print();
      setTimeout(()=>{area.style.display='none'; area.innerHTML='';}, 500);
    });

    // Select all
    $('selAll').addEventListener('change', (e)=>{
      document.querySelectorAll('.sel').forEach(x=>x.checked=e.target.checked);
    });

    // Auto-show dashboard if already “logged in”
    (function(){
      const token = localStorage.getItem(ADMIN_KEY);
      if(token){
        $('loginCard').style.display='none';
        $('dash').style.display='block';
        loadPage(1);
      }
    })();
  </script>

  <style>
/* ---------- Admin readability hard-overrides ---------- */

/* 1) Search/inputs: visible placeholder in Safari/Chrome/Firefox */
.admin-wrap input,
.admin-wrap select,
.admin-wrap textarea { color: var(--text) !important; }

/* Safari/Chromium */
.admin-wrap input::-webkit-input-placeholder,
.admin-wrap textarea::-webkit-input-placeholder { color: var(--muted) !important; opacity: 1 !important; }
/* Firefox */
.admin-wrap input::placeholder,
.admin-wrap textarea::placeholder { color: var(--muted) !important; opacity: 1 !important; }

/* 2) Table headers: stronger contrast */
.admin-wrap table thead th {
  color: var(--text) !important;
  font-weight: 700 !important;
}
.theme-light .admin-wrap table thead th { color: #0b1115 !important; }

/* 3) Disabled buttons: stop Safari’s dimming and set readable colors */
.admin-wrap .btn:disabled,
.admin-wrap button[disabled] {
  opacity: 1 !important;            /* cancel browser fade */
  cursor: not-allowed !important;
  border-color: var(--border) !important;
}

/* light */
.theme-light .admin-wrap .btn:disabled,
.theme-light .admin-wrap button[disabled] {
  background: #eef2f7 !important;
  color: #48566a !important;
}


/* 4) Ghost buttons (Logout) text contrast in light */
.theme-light .admin-wrap .btn.ghost {
  color: #0b1115 !important;
  border-color: var(--border) !important;
}

/* 5) Make tiny “Edit” labels readable even when disabled */
.admin-wrap .actions .btn:disabled { font-weight: 700 !important; }
</style>


  <style>
/* Force all button text to black for visibility */
button,
.btn {
  color: #000 !important;
}

/* Optional: keep dark background for dark mode but readable text */
.theme-dark button,
.theme-dark .btn {
  color: #000 !important;
  background-color: #f0f0f0 !important;
  border: 1px solid #999 !important;
}
</style>



<style>


/* 2️⃣ Give the whole edit box a light-blue background and subtle border */
#editCard {
  background-color: #e6f4ff !important;   /* light blue */
  border: 1px solid #b3d7ff !important;
  border-radius: 12px;
}

/* optional: tone text contrast slightly darker inside that box */
#editCard h3, #editCard h4, #editCard label {
  color: #0b1115;
}
</style>



  
</body>
</html>

