<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MTERMS 2026 — Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSP: allow Heroku API + Google Fonts -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob: https:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://mterm2026-559f9bf571b5.herokuapp.com; base-uri 'self'; form-action 'self'; frame-ancestors 'self'">

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css" />
  <style>
    body{ background:#0f1115; color:#e8e8e8; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .container{ max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .card{ border:1px solid #2a2a2a; border-radius:12px; padding:16px; background:#111317; }
    h1{ font-size:1.6rem; margin:0 0 12px; }
    h2{ font-size:1.2rem; margin:16px 0 8px; }
    .btn{ cursor:pointer; }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 900px){ .grid-2{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="regTitle">MTERMS 2026 Registration</h1>
    <p style="opacity:.85">Complete your details below. Fees and add-ons are shown live based on the current phase.</p>

    <!-- Pricing preview -->
    <div id="pricingMount" class="card" style="margin-top:12px"></div>

    <!-- Full Registration (same as before, moved here) -->
    <div id="full-reg" class="card" style="margin-top:16px">
      <div style="font-weight:700;margin-bottom:8px">Registration (beta)</div>

      <form id="fullRegForm">
        <!-- Category + Dinner -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <label>Category
            <select name="category" id="f-category" required>
              <option value="">Select…</option>
              <option value="student">Student</option>
              <option value="academia">Academia</option>
              <option value="industry">Industry</option>
            </select>
          </label>
          <label style="display:flex;align-items:center;gap:8px;margin-top:auto">
            <input type="checkbox" name="addons.dinner" /> Add Gala Dinner (RM150)
          </label>
        </div>

        <!-- Personal -->
        <fieldset style="border:1px solid #2a2a2a;border-radius:8px;padding:12px;margin-bottom:12px">
          <legend>Personal</legend>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
            <input name="personal.firstName" placeholder="First name" required />
            <input name="personal.lastName"  placeholder="Last name" required />
            <input name="personal.email" type="email" placeholder="Email" required />
            <input name="personal.phone" placeholder="Phone (optional)" />
            <input name="personal.country" placeholder="Country (optional)" />
          </div>
        </fieldset>

        <!-- Professional -->
        <fieldset style="border:1px solid #2a2a2a;border-radius:8px;padding:12px;margin-bottom:12px">
          <legend>Affiliation</legend>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
            <input name="professional.affiliation" placeholder="University / Company" required />
            <input name="professional.department"  placeholder="Department (optional)" />
            <input name="professional.roleTitle"   placeholder="Role/Title (optional)" />
          </div>
        </fieldset>

        <!-- Student-only -->
        <fieldset id="studentOnly" style="display:none;border:1px solid #2a2a2a;border-radius:8px;padding:12px;margin-bottom:12px">
          <legend>Student details</legend>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
            <input name="student.university" placeholder="University" />
            <select name="student.level">
              <option value="">Level</option>
              <option value="UG">UG</option>
              <option value="MSc">MSc</option>
              <option value="PhD">PhD</option>
              <option value="Other">Other</option>
            </select>
            <input name="student.expectedGradYear" type="number" placeholder="Expected grad year" />
          </div>
          <div style="margin-top:8px">
            Student proof:
            <label style="margin-left:8px"><input type="radio" name="studentProof" value="now"> I will upload now (coming soon)</label>
            <label style="margin-left:16px"><input type="radio" name="studentProof" value="later" checked> I will upload later via email/portal</label>
          </div>
        </fieldset>

        <!-- Program -->
        <fieldset style="border:1px solid #2a2a2a;border-radius:8px;padding:12px;margin-bottom:12px">
          <legend>Program</legend>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="f-presenting" /> I am a presenter (talk/poster/workshop)
          </label>
          <div id="presentFields" style="display:none;margin-top:8px">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <select id="f-type">
                <option value="talk">Talk</option>
                <option value="poster">Poster</option>
                <option value="workshop">Workshop</option>
              </select>
              <input id="f-topicArea" placeholder="Topic area (optional)" />
            </div>
            <input id="f-title" placeholder="Presentation title" style="margin-top:8px" />
          </div>
        </fieldset>

        <!-- Billing (optional) -->
        <details style="margin-bottom:12px">
          <summary>Billing & invoice (optional)</summary>
          <div style="margin-top:8px;display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
            <input name="billing.billTo" placeholder="Bill-to name" />
            <input name="billing.taxNo" placeholder="Company Tax/GST/VAT No." />
            <input name="billing.poNumber" placeholder="Purchase order #" />
          </div>
        </details>

        <!-- Address (optional) -->
        <details style="margin-bottom:12px">
          <summary>Postal address (optional)</summary>
          <div style="margin-top:8px;display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
            <input name="address.line1" placeholder="Address line 1" />
            <input name="address.line2" placeholder="Address line 2" />
            <input name="address.city" placeholder="City" />
            <input name="address.state" placeholder="State/Province" />
            <input name="address.postcode" placeholder="Postcode" />
            <input name="address.country" placeholder="Country" />
          </div>
        </details>

        <!-- Consents -->
        <div style="margin:8px 0">
          <label><input type="checkbox" id="c-pdpa" required /> I consent to PDPA/privacy policy.</label><br>
          <label><input type="checkbox" id="c-coc" required /> I agree to the Code of Conduct.</label><br>
          <label><input type="checkbox" id="c-mkt" /> I’d like to receive event updates (optional).</label>
        </div>

        <button class="btn" type="submit">Submit registration (beta)</button>
      </form>

      <div id="fullRegResult" style="margin-top:10px;font-size:0.95rem"></div>
    </div>

   <!-- MTERM2026 — Upload Center (with progress) -->
<div id="upload-center" class="card" style="margin-top:16px">
  <div style="font-weight:700;margin-bottom:8px">Upload Center (beta)</div>
  <p>Use your registration code and email to upload files. Accepted: PDF, JPG, PNG (≤10 MB).</p>

  <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px">
    <input id="u-regCode" placeholder="Registration code e.g. MTERM2026-000002">
    <input id="u-email" type="email" placeholder="Email used to register">
  </div>

  <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px">
    <select id="u-type">
      <option value="studentProof">Student proof</option>
      <option value="bankReceipt">Bank transfer receipt</option>
      <option value="abstract">Abstract</option>
      <option value="slides">Slides</option>
    </select>
    <input id="u-file" type="file" accept=".pdf,.jpg,.jpeg,.png">
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn" id="u-upload">Upload</button>
    <button class="btn ghost" id="u-refresh">Refresh history</button>
  </div>

  <!-- Progress UI -->
  <div id="u-progress" style="display:none;margin-top:10px">
    <div style="height:8px;background:#1a1c22;border-radius:9999px;overflow:hidden;border:1px solid #2a2a2a">
      <div id="u-progress-bar" style="height:8px;width:0%;background:#3b82f6;transition:width .15s;"></div>
    </div>
    <div id="u-progress-text" style="margin-top:6px;font-size:.9rem;opacity:.9">Uploading… 0%</div>
  </div>

  <div id="u-msg" style="margin-top:10px;font-size:0.95rem"></div>
  <div id="u-history" style="margin-top:10px"></div>
</div>


  </div>

 <script>
document.addEventListener('DOMContentLoaded', () => {
  const API = 'https://mterm2026-559f9bf571b5.herokuapp.com';

  // Helpers
  const $ = (id) => document.getElementById(id);
  const show = (el, on) => el && (el.style.display = on ? 'block' : 'none');

  // ===== Pricing preview =====
  (async () => {
    const mount = $('pricingMount');
    try {
      const r = await fetch(`${API}/api/pricing/table`, { cache: 'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      mount.innerHTML = `
        <div style="font-weight:700;margin-bottom:8px">Indicative Registration Fees (${data.currency})</div>
        <table style="width:100%;border-collapse:collapse;font-size:0.95rem">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #333">Phase</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #333">Student</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #333">Academia</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #333">Industry</th>
            </tr>
          </thead>
          <tbody>
            ${data.rows.map(r => `
              <tr>
                <td style="padding:8px">${r.phase}</td>
                <td style="padding:8px;text-align:right">RM ${r.prices.student.toFixed(0)}</td>
                <td style="padding:8px;text-align:right">RM ${r.prices.academia.toFixed(0)}</td>
                <td style="padding:8px;text-align:right">RM ${r.prices.industry.toFixed(0)}</td>
              </tr>`).join('')}
          </tbody>
        </table>
        <div style="margin-top:8px;opacity:0.9">Dinner bundle: +RM ${data.dinnerAddon} (optional).</div>
        <div style="margin-top:4px;opacity:0.75">Current phase: <strong>${data.nowPhase}</strong>.</div>
      `;
    } catch (e) {
      mount.innerHTML = `<div style="color:#ff6b6b">❌ Pricing load failed: ${e.message}</div>`;
      console.error('Pricing preview failed', e);
    }
  })();

  // ===== Full Registration form =====
  const form = $('fullRegForm');
  const out  = $('fullRegResult');

  const selCategory = $('f-category');
  const studentOnly = $('studentOnly');
  const chkPresenting = $('f-presenting');
  const presentFields = $('presentFields');

  selCategory.addEventListener('change', () => show(studentOnly, selCategory.value === 'student'));
  chkPresenting.addEventListener('change', () => show(presentFields, chkPresenting.checked));

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    out.textContent = 'Submitting…';

    const fd = new FormData(form);
    const payload = {
      category: fd.get('category'),
      addons: { dinner: fd.get('addons.dinner') === 'on' },
      personal: {
        firstName: fd.get('personal.firstName'),
        lastName:  fd.get('personal.lastName'),
        email:     fd.get('personal.email'),
        phone:     fd.get('personal.phone'),
        country:   fd.get('personal.country')
      },
      professional: {
        affiliation: fd.get('professional.affiliation'),
        department:  fd.get('professional.department'),
        roleTitle:   fd.get('professional.roleTitle')
      },
      address: {
        line1: fd.get('address.line1'),
        line2: fd.get('address.line2'),
        city:  fd.get('address.city'),
        state: fd.get('address.state'),
        postcode: fd.get('address.postcode'),
        country:  fd.get('address.country')
      },
      billing: {
        billTo:   fd.get('billing.billTo'),
        taxNo:    fd.get('billing.taxNo'),
        poNumber: fd.get('billing.poNumber')
      },
      program: {
        presenting: $('f-presenting').checked,
        type:       $('f-type')?.value || 'none',
        title:      $('f-title')?.value || '',
        topicArea:  $('f-topicArea')?.value || ''
      },
      student: (fd.get('category') === 'student') ? {
        university: fd.get('student.university'),
        level:      fd.get('student.level') || 'Other',
        expectedGradYear: fd.get('student.expectedGradYear') ? Number(fd.get('student.expectedGradYear')) : undefined
      } : undefined,
      studentProof: (fd.get('category') === 'student') ? {
        deferred: (document.querySelector('input[name="studentProof"]:checked')?.value === 'later')
      } : undefined,
      consents: {
        pdpa: $('c-pdpa').checked,
        codeOfConduct: $('c-coc').checked,
        marketingOptIn: $('c-mkt').checked
      }
    };

    try {
      const r = await fetch(`${API}/api/registrations`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || `HTTP ${r.status}`);

      out.innerHTML = `
        ✅ Saved. Your code: <strong>${data.regCode}</strong><br>
        Amount due: <strong>RM ${data.amount}</strong> (${data.currency}) — Phase: ${data.phase}<br>
        Student proof: ${data.studentProof?.required ? (data.studentProof.deferred ? 'Upload later' : 'Required') : 'Not applicable'}<br>
        <em>(Payment coming soon)</em>
      `;
      form.reset();
      show(studentOnly, false);
      show(presentFields, false);
    } catch (err) {
      out.innerHTML = `<span style="color:#ff6b6b">❌ Submit failed: ${err.message}</span>`;
      console.error('Submit failed', err);
    }
  });

  // ===== Upload Center (GridFS) =====
document.addEventListener('DOMContentLoaded', () => {
  const API = 'https://mterm2026-559f9bf571b5.herokuapp.com';

  // Elements
  const regCode = document.getElementById('u-regCode');
  const email   = document.getElementById('u-email');
  const typeSel = document.getElementById('u-type');
  const fileInp = document.getElementById('u-file');
  const uploadBtn = document.getElementById('u-upload');
  const refreshBtn = document.getElementById('u-refresh');
  const msg     = document.getElementById('u-msg');
  const hist    = document.getElementById('u-history');
  const progBox = document.getElementById('u-progress');
  const progBar = document.getElementById('u-progress-bar');
  const progTxt = document.getElementById('u-progress-text');

  function setBusy(isBusy) {
    uploadBtn.disabled = isBusy;
    fileInp.disabled = isBusy;
    uploadBtn.style.opacity = isBusy ? 0.6 : 1;
    uploadBtn.style.pointerEvents = isBusy ? 'none' : 'auto';
    uploadBtn.textContent = isBusy ? 'Uploading…' : 'Upload';
  }

  function showProgress(show) {
    progBox.style.display = show ? 'block' : 'none';
    if (!show) {
      progBar.style.width = '0%';
      progTxt.textContent = 'Uploading… 0%';
    }
  }

  function updateProgress(pct) {
    const p = Math.max(0, Math.min(100, Math.floor(pct)));
    progBar.style.width = p + '%';
    progTxt.textContent = 'Uploading… ' + p + '%';
  }

  async function listHistory() {
    msg.textContent = 'Loading history…';
    hist.innerHTML = '';
    try {
      const r = await fetch(`${API}/api/uploads/history?regCode=${encodeURIComponent(regCode.value)}&email=${encodeURIComponent(email.value)}&type=${encodeURIComponent(typeSel.value)}`);
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || `HTTP ${r.status}`);
      if (!data.count) {
        hist.innerHTML = '<div style="opacity:0.8">No files yet for this type.</div>';
      } else {
        hist.innerHTML = data.rows.map(row => `
          <div style="padding:8px;border:1px solid #2a2a2a;border-radius:8px;margin-bottom:8px">
            <div><strong>v${row.version}</strong> — ${row.filename}</div>
            <div style="opacity:0.8">Uploaded: ${new Date(row.uploadedAt).toLocaleString()}</div>
            <div style="margin-top:6px">
              <a href="${API}${row.downloadUrl}" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
        `).join('');
      }
      msg.textContent = '';
    } catch (e) {
      msg.innerHTML = `<span style="color:#ff6b6b">❌ History failed: ${e.message}</span>`;
    }
  }

  refreshBtn?.addEventListener('click', listHistory);

  uploadBtn?.addEventListener('click', () => {
    msg.textContent = '';
    const file = fileInp.files?.[0];
    if (!regCode.value || !email.value || !file) {
      msg.textContent = '❌ regCode, email, and file are required';
      return;
    }
    if (file.size > 10 * 1024 * 1024) {
      msg.textContent = '❌ File too large (max 10 MB)';
      return;
    }

    // Build form-data
    const fd = new FormData();
    fd.append('regCode', regCode.value.trim());
    fd.append('email', email.value.trim());
    fd.append('type', typeSel.value);
    fd.append('file', file, file.name);

    // Use XMLHttpRequest for progress events
    const xhr = new XMLHttpRequest();
    xhr.open('POST', `${API}/api/uploads/gridfs`, true);

    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = (e.loaded / e.total) * 100;
        updateProgress(pct);
      } else {
        // Unknown size (Safari sometimes) — show indeterminate growth
        const current = parseInt(progBar.style.width) || 0;
        updateProgress(Math.min(95, current + 5));
      }
    };

    xhr.onerror = () => {
      setBusy(false);
      showProgress(false);
      msg.innerHTML = '<span style="color:#ff6b6b">❌ Upload failed (network)</span>';
    };

    xhr.onload = () => {
      setBusy(false);
      updateProgress(100);
      setTimeout(() => showProgress(false), 600);

      if (xhr.status >= 200 && xhr.status < 300) {
        let data;
        try { data = JSON.parse(xhr.responseText || '{}'); } catch { data = {}; }
        msg.textContent = `✅ Uploaded v${data.version || '?'} .`;
        fileInp.value = '';
        listHistory();
      } else {
        let errMsg = `HTTP ${xhr.status}`;
        try {
          const err = JSON.parse(xhr.responseText || '{}');
          if (err.error) errMsg = err.error;
        } catch {}
        msg.innerHTML = `<span style="color:#ff6b6b">❌ Upload failed: ${errMsg}</span>`;
      }
    };

    // Start
    setBusy(true);
    showProgress(true);
    updateProgress(1);
    xhr.send(fd);
  });
});

});
</script>

</body>
</html>
